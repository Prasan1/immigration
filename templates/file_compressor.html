{% extends "base.html" %}

{% block title %}PDF File Compressor - {{ g.branding.site_name }}{% endblock %}

{% block nav_compressor_active %}active{% endblock %}

{% block head %}
    <style>
        :root {
            --accent-navy: #1E3A5F;
            --text-dark: #2C3E50;
            --text-muted: #6B7280;
            --border-gray: #E5E7EB;
            --brand-purple: #667eea;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
        }

        /* Hero Section with Artistic Flag */
        .hero-section {
            background: linear-gradient(135deg, #F8FAFC 0%, #E8F4F8 100%);
            color: var(--text-dark);
            padding: 100px 0 80px 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        /* Artistic Wavy US Flag */
        .hero-section::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -5%;
            width: 110%;
            height: 120%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 600' preserveAspectRatio='none'%3E%3Cdefs%3E%3Cpattern id='starscompressor' x='0' y='0' width='80' height='60' patternUnits='userSpaceOnUse'%3E%3Ccircle cx='20' cy='15' r='4' fill='rgba(255,255,255,0.4)'/%3E%3Ccircle cx='60' cy='15' r='4' fill='rgba(255,255,255,0.4)'/%3E%3Ccircle cx='40' cy='35' r='4' fill='rgba(255,255,255,0.4)'/%3E%3C/pattern%3E%3C/defs%3E%3Cpath d='M 0 0 Q 100 20 200 0 Q 300 -20 380 0 L 380 230 Q 300 250 200 230 Q 100 210 0 230 Z' fill='rgba(159,175,210,0.3)' /%3E%3Crect x='0' y='0' width='380' height='230' fill='url(%23starscompressor)' opacity='0.8'/%3E%3Cpath d='M 0 0 Q 250 20 500 0 Q 750 -20 1000 0 L 1000 46 Q 750 66 500 46 Q 250 26 0 46 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 92 Q 250 112 500 92 Q 750 72 1000 92 L 1000 138 Q 750 158 500 138 Q 250 118 0 138 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 184 Q 250 204 500 184 Q 750 164 1000 184 L 1000 230 Q 750 250 500 230 Q 250 210 0 230 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 276 Q 250 296 500 276 Q 750 256 1000 276 L 1000 322 Q 750 342 500 322 Q 250 302 0 322 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 368 Q 250 388 500 368 Q 750 348 1000 368 L 1000 414 Q 750 434 500 414 Q 250 394 0 414 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 460 Q 250 480 500 460 Q 750 440 1000 460 L 1000 506 Q 750 526 500 506 Q 250 486 0 506 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 552 Q 250 572 500 552 Q 750 532 1000 552 L 1000 600 Q 750 600 500 600 Q 250 600 0 600 Z' fill='rgba(229,135,144,0.25)'/%3E%3Cpath d='M 0 100 Q 125 60 250 100 T 500 100 T 750 100 T 1000 100 L 1000 150 Q 875 190 750 150 T 500 150 T 250 150 T 0 150 Z' fill='rgba(159,175,210,0.15)' opacity='0.6'/%3E%3Cpath d='M 0 300 Q 125 340 250 300 T 500 300 T 750 300 T 1000 300 L 1000 250 Q 875 210 750 250 T 500 250 T 250 250 T 0 250 Z' fill='rgba(229,135,144,0.12)' opacity='0.5'/%3E%3Cpath d='M 0 450 Q 125 410 250 450 T 500 450 T 750 450 T 1000 450 L 1000 500 Q 875 540 750 500 T 500 500 T 250 500 T 0 500 Z' fill='rgba(159,175,210,0.12)' opacity='0.5'/%3E%3C/svg%3E");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.85;
            z-index: 0;
            animation: gentleFlagFlow 40s ease-in-out infinite;
            will-change: transform;
        }

        @keyframes gentleFlagFlow {
            0%, 100% {
                transform: translateX(0) translateY(0) scale(1.05);
            }
            50% {
                transform: translateX(-1%) translateY(1%) scale(1.05);
            }
        }

        .hero-section h1 {
            position: relative;
            z-index: 1;
            font-weight: 600;
        }

        .hero-section .lead,
        .hero-section p {
            position: relative;
            z-index: 1;
            color: var(--text-muted);
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 60px;
        }

        .upload-zone {
            background: white;
            border: 2px dashed var(--border-gray);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 30px;
        }

        .upload-zone:hover {
            border-color: var(--brand-purple);
            background: #F9FAFB;
        }

        .upload-zone.dragover {
            border-color: var(--brand-purple);
            background: #F5F7FA;
        }

        .upload-icon {
            font-size: 64px;
            color: var(--brand-purple);
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .info-card {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 30px;
            margin-bottom: 30px;
        }

        .info-card h4 {
            color: var(--text-dark);
            font-weight: 600;
        }

        .usage-badge {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            color: #92400E;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .usage-badge.unlimited {
            background: #D1FAE5;
            border-color: #10B981;
            color: #065F46;
        }

        .btn-primary {
            background: var(--accent-navy);
            border: none;
            padding: 14px 35px;
            font-weight: 500;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #2C5282;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 95, 0.25);
        }

        .btn-outline-primary {
            border: 1px solid var(--border-gray);
            color: var(--text-dark);
            background: white;
            padding: 14px 35px;
            font-weight: 500;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .btn-outline-primary:hover {
            border-color: var(--brand-purple);
            color: var(--brand-purple);
            background: white;
        }

        .job-item {
            background: white;
            border: 1px solid var(--border-gray);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .job-item:hover {
            border-color: var(--brand-purple);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .job-info {
            flex: 1;
        }

        .job-info h6 {
            color: var(--text-dark);
            font-weight: 600;
        }

        .job-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-processing {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-failed {
            background: #FEE2E2;
            color: #991B1B;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
        }

        .action-buttons {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .btn-action {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border-gray);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .btn-action:hover {
            border-color: var(--brand-purple);
            color: var(--brand-purple);
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .btn-home {
            background: var(--accent-navy);
            color: white;
            border-color: var(--accent-navy);
        }

        .btn-home:hover {
            background: #2C5282;
            border-color: #2C5282;
            color: white;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="action-buttons">
        <a href="/" class="btn-action btn-home">
            <i class="fas fa-home"></i> Home
        </a>
        <a href="/forms" class="btn-action">
            <i class="fas fa-file-alt"></i> Forms
        </a>
    </div>

    <div class="hero-section">
        <div class="container text-center">
            <h1><i class="fas fa-file-archive"></i> PDF File Compressor</h1>
            <p class="lead">Reduce PDF file sizes for immigration applications (DS-260, DS-160, I-485, etc.)</p>
            <p class="mb-0">Free tier: 5 compressions/month • Premium unlimited: Upgrade to Professional plan</p>
        </div>
    </div>

    <div class="container main-container">
        {% if user %}
            {% if usage_info %}
                {% if usage_info.tier == 'premium' %}
                    <div class="usage-badge unlimited">
                        <i class="fas fa-check-circle"></i> Unlimited Premium Compression Available ({{ usage_info.tier|title }} Subscription)
                    </div>
                {% else %}
                    <div class="usage-badge">
                        <i class="fas fa-info-circle"></i>
                        Free Tier: {{ usage_info.remaining }} of {{ usage_info.limit }} compressions remaining this month
                    </div>
                {% endif %}
            {% endif %}

            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <h3>Click to upload or drag & drop PDF file</h3>
                <p class="text-muted mb-0">Maximum file size:
                    {% if usage_info and usage_info.tier == 'premium' %}50MB{% else %}2MB{% endif %}
                </p>
            </div>

            <!-- Compression Options -->
            <div class="info-card text-center" id="compressionOptions" style="display: none;">
                <h4 class="mb-3">Ready to compress your PDF</h4>
                <p class="text-muted mb-4" id="compressionInfo">
                    {% if usage_info and usage_info.tier == 'premium' %}
                        Premium quality compression (70-85% reduction) • Up to 50MB file size
                    {% else %}
                        Basic compression (50-60% reduction) • Up to 2MB file size
                    {% endif %}
                </p>
                <button class="btn btn-primary btn-lg" onclick="startCompression()">
                    <i class="fas fa-compress"></i> Compress PDF Now
                </button>
                {% if usage_info and usage_info.tier != 'premium' and usage_info.remaining <= 0 %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-circle"></i>
                        You've used all 5 free compressions this month.
                        <a href="/pricing" class="alert-link">Upgrade to Professional</a> for unlimited premium compression.
                    </div>
                {% endif %}
            </div>

            <!-- Recent Compressions -->
            <div class="info-card">
                <h4 class="mb-4"><i class="fas fa-history"></i> Recent Compressions</h4>
                <div id="jobsList">
                    <p class="text-muted text-center">No compression jobs yet</p>
                </div>
            </div>

        {% else %}
            <!-- Not logged in -->
            <div class="info-card text-center">
                <h3 class="mb-4">Please sign in to use the file compressor</h3>
                <p class="text-muted mb-4">Free compression available to all users (5 files/month)</p>
                <a href="/login" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </a>
            </div>
        {% endif %}

        <!-- Info Section -->
        <div class="info-card">
            <h4 class="mb-3"><i class="fas fa-question-circle"></i> Why compress PDF files?</h4>
            <p>Many immigration portals have strict file size limits:</p>
            <ul>
                <li><strong>DS-260 / DS-160:</strong> 2MB per document</li>
                <li><strong>I-485 / N-400:</strong> 5MB per file</li>
                <li><strong>Canadian Immigration:</strong> 4MB limit</li>
                <li><strong>UK Visa Applications:</strong> 2MB per document</li>
            </ul>
            <p class="mb-0">Our compressor reduces file sizes while maintaining quality for submission.</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-light" role="status"></div>
        <div class="loading-text">Processing...</div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        let currentJobId = null;
        let currentFile = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadRecentJobs();

            // File upload handlers
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', handleFileSelect);

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });

            // Clear jobs list and reload when user logs in/out to prevent session data leakage
            if (typeof Clerk !== 'undefined') {
                Clerk.load().then(clerk => {
                    clerk.addListener(({ session }) => {
                        // Clear jobs list
                        const jobsList = document.getElementById('jobsList');
                        if (jobsList) {
                            jobsList.innerHTML = '<p class="text-muted text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</p>';
                        }
                        // Reload jobs after short delay to allow session to fully update
                        setTimeout(() => {
                            loadRecentJobs();
                        }, 500);
                    });
                });
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Please select a PDF file');
                return;
            }

            currentFile = file;
            document.getElementById('compressionOptions').style.display = 'block';
        }

        async function startCompression() {
            if (!currentFile) return;

            showLoading('Uploading file...');

            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('tier', 'free');  // Backend will use user's subscription tier

            try {
                const response = await fetch('/api/file-compressor/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentJobId = data.job_id;
                    // Start compression immediately
                    await compressFile(data.job_id);
                } else {
                    hideLoading();
                    if (data.redirect) {
                        // User hit their limit
                        if (confirm(data.message + '\n\nGo to pricing page?')) {
                            window.location.href = data.redirect;
                        }
                    } else {
                        alert(data.error || 'Upload failed');
                    }
                }
            } catch (error) {
                hideLoading();
                alert('Upload failed: ' + error.message);
            }
        }

        async function compressFile(jobId) {
            showLoading('Compressing PDF...');

            try {
                const response = await fetch(`/api/file-compressor/jobs/${jobId}/compress`, {
                    method: 'POST'
                });

                const data = await response.json();
                hideLoading();

                if (response.ok) {
                    alert('Compression completed successfully!');
                    loadRecentJobs();
                    resetUpload();
                } else {
                    alert(data.error || 'Compression failed');
                }
            } catch (error) {
                hideLoading();
                alert('Compression failed: ' + error.message);
            }
        }

        async function loadRecentJobs() {
            try {
                const response = await fetch('/api/file-compressor/jobs');
                const jobs = await response.json();

                const jobsList = document.getElementById('jobsList');

                if (jobs.length === 0) {
                    jobsList.innerHTML = '<p class="text-muted text-center">No compression jobs yet</p>';
                    return;
                }

                jobsList.innerHTML = jobs.map(job => `
                    <div class="job-item">
                        <div class="job-info">
                            <h6 class="mb-1">${job.original_filename}</h6>
                            <small class="text-muted">
                                ${formatFileSize(job.original_file_size)} →
                                ${job.compressed_file_size ? formatFileSize(job.compressed_file_size) : '...'}
                                ${job.compression_ratio ? `(${Math.round((1 - job.compression_ratio) * 100)}% reduction)` : ''}
                            </small>
                            <div class="mt-1">
                                <span class="status-badge status-${job.status}">${job.status}</span>
                                <small class="text-muted ms-2">${job.compression_tier} tier</small>
                            </div>
                        </div>
                        <div class="job-actions">
                            ${job.status === 'completed' ? `
                                <a href="/api/file-compressor/jobs/${job.id}/download" class="btn btn-sm btn-success">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteJob(${job.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Delete this compression job?')) return;

            try {
                const response = await fetch(`/api/file-compressor/jobs/${jobId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadRecentJobs();
                }
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        function resetUpload() {
            currentFile = null;
            currentJobId = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('compressionOptions').style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function showLoading(text) {
            document.getElementById('loadingOverlay').classList.add('active');
            document.querySelector('.loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    </script>
{% endblock %}
